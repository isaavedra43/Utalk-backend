/**
 * üîß SCRIPT PARA VERIFICAR Y CONFIGURAR VARIABLES DE ENTORNO CR√çTICAS
 * 
 * Este script verifica que todas las variables de entorno necesarias est√©n configuradas
 * y proporciona instrucciones para configurarlas correctamente.
 * 
 * @version 1.0.0
 * @author Backend Team
 */

const fs = require('fs');
const path = require('path');

console.log('üîß VERIFICANDO CONFIGURACI√ìN DE VARIABLES DE ENTORNO...');
console.log('=' .repeat(60));

// Variables cr√≠ticas requeridas
const CRITICAL_VARS = {
  // Firebase (CR√çTICO para subida de archivos)
  FIREBASE_PROJECT_ID: {
    description: 'ID del proyecto de Firebase',
    example: 'tu-proyecto-firebase',
    critical: true
  },
  FIREBASE_STORAGE_BUCKET: {
    description: 'Bucket de Firebase Storage',
    example: 'tu-proyecto-firebase.appspot.com',
    critical: true
  },
  FIREBASE_SERVICE_ACCOUNT_KEY: {
    description: 'Clave de cuenta de servicio de Firebase (JSON)',
    example: '{"type":"service_account",...}',
    critical: true
  },
  
  // Twilio (CR√çTICO para mensajer√≠a)
  TWILIO_ACCOUNT_SID: {
    description: 'Account SID de Twilio',
    example: 'ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
    critical: true
  },
  TWILIO_AUTH_TOKEN: {
    description: 'Auth Token de Twilio',
    example: 'tu-auth-token-aqui',
    critical: true
  },
  TWILIO_WHATSAPP_NUMBER: {
    description: 'N√∫mero de WhatsApp de Twilio',
    example: 'whatsapp:+1234567890',
    critical: true
  },
  
  // JWT (CR√çTICO para autenticaci√≥n)
  JWT_SECRET: {
    description: 'Secreto para firmar JWT',
    example: 'tu-super-secret-jwt-key-aqui',
    critical: true
  },
  
  // Redis (IMPORTANTE para funcionalidad completa)
  REDIS_URL: {
    description: 'URL de conexi√≥n a Redis',
    example: 'redis://localhost:6379',
    critical: false
  },
  REDISCLOUD_URL: {
    description: 'URL de Redis Cloud (alternativa)',
    example: 'redis://tu-rediscloud-url',
    critical: false
  }
};

// Verificar variables de entorno
function checkEnvironmentVariables() {
  const missing = [];
  const present = [];
  const criticalMissing = [];
  
  console.log('üìã VERIFICANDO VARIABLES DE ENTORNO...\n');
  
  for (const [varName, config] of Object.entries(CRITICAL_VARS)) {
    const value = process.env[varName];
    
    if (value) {
      present.push({ name: varName, config });
      console.log(`‚úÖ ${varName}: ${config.description}`);
    } else {
      missing.push({ name: varName, config });
      if (config.critical) {
        criticalMissing.push({ name: varName, config });
      }
      console.log(`‚ùå ${varName}: ${config.description} - FALTANTE`);
    }
  }
  
  console.log('\n' + '=' .repeat(60));
  console.log('üìä RESUMEN DE VERIFICACI√ìN:');
  console.log(`‚úÖ Variables configuradas: ${present.length}`);
  console.log(`‚ùå Variables faltantes: ${missing.length}`);
  console.log(`üö® Variables cr√≠ticas faltantes: ${criticalMissing.length}`);
  
  return { missing, present, criticalMissing };
}

// Generar archivo .env de ejemplo
function generateEnvExample() {
  const envExamplePath = path.join(__dirname, '../.env.example');
  const envPath = path.join(__dirname, '../.env');
  
  console.log('\nüìù GENERANDO ARCHIVO .env DE EJEMPLO...');
  
  let envContent = `# =============================================================================
# UTalk Backend Environment Variables - CONFIGURACI√ìN CR√çTICA
# =============================================================================
# 
# üî¥ IMPORTANTE: Configura estas variables para que funcione la subida de archivos
# =============================================================================

# üî¥ VARIABLES CR√çTICAS (REQUERIDAS PARA FUNCIONAR)
# =============================================================================

# Puerto del servidor (Railway lo inyecta autom√°ticamente)
PORT=3001

# Entorno de ejecuci√≥n
NODE_ENV=production

# Secreto para JWT (REQUERIDO)
JWT_SECRET=tu-super-secret-jwt-key-aqui

# =============================================================================
# üî• FIREBASE CONFIGURACI√ìN (CR√çTICO PARA SUBIDA DE ARCHIVOS)
# =============================================================================

# ID del proyecto de Firebase
FIREBASE_PROJECT_ID=tu-proyecto-firebase

# Bucket de Firebase Storage (CR√çTICO - debe existir)
FIREBASE_STORAGE_BUCKET=tu-proyecto-firebase.appspot.com

# Clave de cuenta de servicio de Firebase (JSON completo)
FIREBASE_SERVICE_ACCOUNT_KEY={"type":"service_account","project_id":"tu-proyecto","private_key_id":"...","private_key":"-----BEGIN PRIVATE KEY-----\\n...\\n-----END PRIVATE KEY-----\\n","client_email":"firebase-adminsdk-xxx@tu-proyecto.iam.gserviceaccount.com","client_id":"...","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-xxx%40tu-proyecto.iam.gserviceaccount.com"}

# =============================================================================
# üì± TWILIO CONFIGURACI√ìN (CR√çTICO PARA MENSAJER√çA)
# =============================================================================

# Account SID de Twilio
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Auth Token de Twilio
TWILIO_AUTH_TOKEN=tu-twilio-auth-token-aqui

# N√∫mero de WhatsApp de Twilio
TWILIO_WHATSAPP_NUMBER=whatsapp:+1234567890

# =============================================================================
# üóÑÔ∏è REDIS Y CACH√â (IMPORTANTE PARA FUNCIONALIDAD COMPLETA)
# =============================================================================

# URL de conexi√≥n a Redis
REDIS_URL=redis://localhost:6379

# URL de Redis Cloud (alternativa)
REDISCLOUD_URL=redis://tu-rediscloud-url

# =============================================================================
# üîó FRONTEND Y CORS
# =============================================================================

# URLs del frontend permitidas
FRONTEND_URL=https://tu-frontend.com,https://www.tu-frontend.com

# Or√≠genes CORS permitidos
CORS_ORIGINS=https://tu-frontend.com,https://www.tu-frontend.com

# =============================================================================
# üü¢ VARIABLES OPCIONALES (CARACTER√çSTICAS AVANZADAS)
# =============================================================================

# Habilitar IA globalmente
AI_ENABLED=false

# Modelo de IA por defecto
AI_MODEL=gpt-4o-mini

# Temperatura del modelo (0-1)
AI_TEMPERATURE=0.3

# M√°ximo de tokens de respuesta
AI_MAX_TOKENS=150

# Habilitar RAG (Retrieval-Augmented Generation)
AI_RAG_ENABLED=false

# OpenAI API Key (opcional)
OPENAI_API_KEY=tu_openai_api_key_aqui

# =============================================================================
# üìù LOGGING Y MONITOREO
# =============================================================================

# Nivel de logging
LOG_LEVEL=info

# Habilitar logging a archivo
ENABLE_FILE_LOGGING=true

# Directorio de logs
LOG_DIR=./logs

# =============================================================================
# üö´ SEGURIDAD AVANZADA
# =============================================================================

# M√°ximo de intentos fallidos
MAX_FAILED_ATTEMPTS=5

# Duraci√≥n de bloqueo en minutos
BLOCK_DURATION_MINUTES=30

# Umbral de actividad sospechosa
SUSPICIOUS_THRESHOLD=10

# Intervalo de limpieza en minutos
CLEANUP_INTERVAL_MINUTES=60

# =============================================================================
# üîß CONFIGURACI√ìN DEL SERVIDOR
# =============================================================================

# Opciones de Node.js
NODE_OPTIONS=--max-old-space-size=2048

# =============================================================================
# üì° WEBSOCKET Y SOCKETS
# =============================================================================

# M√°ximo de salas por socket
SOCKET_MAX_ROOMS_PER_SOCKET=50

# Log verbose de sockets
SOCKET_LOG_VERBOSE=false

# =============================================================================
# üìã INSTRUCCIONES DE CONFIGURACI√ìN
# =============================================================================
#
# 1. üî• FIREBASE: Ve a https://console.firebase.google.com
#    - Crea un proyecto o usa uno existente
#    - Ve a Storage y crea un bucket
#    - Ve a Project Settings > Service Accounts
#    - Genera una nueva clave privada (JSON)
#    - Copia el contenido JSON a FIREBASE_SERVICE_ACCOUNT_KEY
#
# 2. üì± TWILIO: Ve a https://console.twilio.com
#    - Obt√©n tu Account SID y Auth Token
#    - Configura un n√∫mero de WhatsApp
#
# 3. üóÑÔ∏è REDIS: Usa Redis Cloud o instala Redis localmente
#    - Para desarrollo: redis://localhost:6379
#    - Para producci√≥n: Usa Redis Cloud
#
# 4. üîê JWT_SECRET: Genera una clave secreta fuerte
#    - Usa: node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
#
# =============================================================================
`;

  try {
    fs.writeFileSync(envPath, envContent);
    console.log(`‚úÖ Archivo .env generado: ${envPath}`);
    console.log('üìù Edita el archivo .env con tus valores reales');
  } catch (error) {
    console.error(`‚ùå Error generando archivo .env: ${error.message}`);
  }
}

// Mostrar instrucciones espec√≠ficas
function showInstructions(criticalMissing) {
  if (criticalMissing.length === 0) {
    console.log('\nüéâ ¬°TODAS LAS VARIABLES CR√çTICAS EST√ÅN CONFIGURADAS!');
    console.log('‚úÖ El sistema deber√≠a funcionar correctamente');
    return;
  }
  
  console.log('\nüö® VARIABLES CR√çTICAS FALTANTES:');
  console.log('=' .repeat(60));
  
  criticalMissing.forEach(({ name, config }) => {
    console.log(`\n‚ùå ${name}: ${config.description}`);
    console.log(`   Ejemplo: ${config.example}`);
  });
  
  console.log('\nüîß INSTRUCCIONES PARA CONFIGURAR:');
  console.log('=' .repeat(60));
  
  console.log('\n1. üî• FIREBASE (CR√çTICO PARA SUBIDA DE ARCHIVOS):');
  console.log('   - Ve a https://console.firebase.google.com');
  console.log('   - Crea un proyecto o usa uno existente');
  console.log('   - Ve a Storage y crea un bucket');
  console.log('   - Ve a Project Settings > Service Accounts');
  console.log('   - Genera una nueva clave privada (JSON)');
  console.log('   - Copia el contenido JSON a FIREBASE_SERVICE_ACCOUNT_KEY');
  
  console.log('\n2. üì± TWILIO (CR√çTICO PARA MENSAJER√çA):');
  console.log('   - Ve a https://console.twilio.com');
  console.log('   - Obt√©n tu Account SID y Auth Token');
  console.log('   - Configura un n√∫mero de WhatsApp');
  
  console.log('\n3. üîê JWT_SECRET (CR√çTICO PARA AUTENTICACI√ìN):');
  console.log('   - Genera una clave secreta fuerte:');
  console.log('   - node -e "console.log(require(\'crypto\').randomBytes(64).toString(\'hex\'))"');
  
  console.log('\n4. üóÑÔ∏è REDIS (IMPORTANTE PARA FUNCIONALIDAD COMPLETA):');
  console.log('   - Para desarrollo: redis://localhost:6379');
  console.log('   - Para producci√≥n: Usa Redis Cloud');
  
  console.log('\nüìù DESPU√âS DE CONFIGURAR:');
  console.log('   - Reinicia el servidor');
  console.log('   - Ejecuta este script nuevamente para verificar');
}

// Funci√≥n principal
function main() {
  console.log('üîß VERIFICACI√ìN DE CONFIGURACI√ìN DE VARIABLES DE ENTORNO');
  console.log('=' .repeat(60));
  
  const { missing, present, criticalMissing } = checkEnvironmentVariables();
  
  if (criticalMissing.length > 0) {
    console.log('\nüö® PROBLEMAS CR√çTICOS DETECTADOS:');
    console.log('=' .repeat(60));
    console.log('‚ùå Las siguientes variables cr√≠ticas est√°n faltantes:');
    
    criticalMissing.forEach(({ name }) => {
      console.log(`   - ${name}`);
    });
    
    console.log('\n‚ö†Ô∏è SIN ESTAS VARIABLES, EL SISTEMA NO FUNCIONAR√Å CORRECTAMENTE');
    console.log('   - La subida de archivos fallar√°');
    console.log('   - La mensajer√≠a no funcionar√°');
    console.log('   - La autenticaci√≥n puede fallar');
    
    showInstructions(criticalMissing);
    generateEnvExample();
    
    console.log('\nüîß PR√ìXIMOS PASOS:');
    console.log('1. Configura las variables cr√≠ticas faltantes');
    console.log('2. Reinicia el servidor');
    console.log('3. Ejecuta este script nuevamente para verificar');
    
    process.exit(1);
  } else {
    console.log('\nüéâ ¬°CONFIGURACI√ìN COMPLETA!');
    console.log('‚úÖ Todas las variables cr√≠ticas est√°n configuradas');
    console.log('‚úÖ El sistema deber√≠a funcionar correctamente');
    
    if (missing.length > 0) {
      console.log('\nüìù Variables opcionales faltantes:');
      missing.forEach(({ name, config }) => {
        console.log(`   - ${name}: ${config.description}`);
      });
      console.log('\nüí° Estas variables son opcionales pero mejoran la funcionalidad');
    }
  }
}

// Ejecutar script
if (require.main === module) {
  main();
}

module.exports = { checkEnvironmentVariables, generateEnvExample, showInstructions }; 