{
  "meta": {
    "root": "/Users/israel/Documents/GitHub/Utalk-backend",
    "runtime": "Node 18.x",
    "mode": "read_only_audit"
  },
  "presence": {
    "twilio_resolver": {"exists": true, "ref": "src/config/twilioRouting.js:1-59"},
    "resolver_integration_inbound": {"exists": true, "ref": "src/services/MessageService.js:263-264"},
    "logger_unified_child": {"exists": true, "refs": ["src/middleware/correlation.js:40-70","src/utils/requestLogger.js:1-76"]},
    "pipeline_log": {"exists": true, "ref": "src/index.js:769-785"},
    "list_query_diag": {"exists": true, "ref": "src/repositories/ConversationsRepository.js:210-240"},
    "inbound_write_diag": {"exists": true, "ref": "src/repositories/ConversationsRepository.js:456-460"},
    "controller_logger_shape": {"exists": true, "ref": "src/controllers/ConversationController.js:75-77"},
    "default_viewers_module": {"exists": true, "ref": "src/config/defaultViewers.js:1-18"},
    "default_viewers_merge_inbound": {"exists": true, "ref": "src/repositories/ConversationsRepository.js:452-460"},
    "default_viewers_merge_outbound": {"exists": true, "ref": "src/repositories/ConversationsRepository.js:676-682"},
    "backfill_script": {"exists": true, "ref": "scripts/backfill_add_viewers.js:1-62"}
  },
  "read_query": {
    "router_ref": "src/routes/conversations.js:67-72",
    "controller_ref": "src/controllers/ConversationController.js:51-169",
    "repo_ref": "src/repositories/ConversationsRepository.js:174-269",
    "pseudocode": "collection('conversations').where('workspaceId', '==', req.user.workspaceId).where('tenantId', '==', req.user.tenantId).where('participants', 'array-contains', req.user.email).orderBy('lastMessageAt', 'desc').limit(50)",
    "filters": {
      "workspaceId": {"enabled": true, "source": "req.user.workspaceId", "ref": "src/controllers/ConversationController.js:95"},
      "tenantId": {"enabled": true, "source": "req.user.tenantId", "ref": "src/controllers/ConversationController.js:96"},
      "participantsContains": {"enabled": true, "source": "req.user.email", "ref": "src/controllers/ConversationController.js:98"},
      "status": {"enabled_when": "status!='all'", "ref": "src/controllers/ConversationController.js:97"}
    },
    "orderBy": {"field": "lastMessageAt", "direction": "desc", "ref": "src/repositories/ConversationsRepository.js:54-116"},
    "limit": {"default": 50, "ref": "src/controllers/ConversationController.js:103"},
    "indexes_required": ["firestore.indexes.json:1-8", "firestore.indexes.json:9-16", "firestore.indexes.json:17-24"]
  },
  "write_shapes": {
    "inbound": {
      "service_ref": "src/services/MessageService.js:222-359",
      "repo_ref": "src/repositories/ConversationsRepository.js:325-544",
      "participants_build": {
        "adds_phone": true,
        "adds_agentEmail_if_present": true,
        "adds_default_viewers": true,
        "ref": "src/repositories/ConversationsRepository.js:452-460"
      },
      "workspace_tenant_source": "resolver/env",
      "idempotency_by_messageId": true,
      "fields": ["lastMessage","lastMessageAt","messageCount","unreadCount","participants","status","workspaceId","tenantId","createdAt","updatedAt"]
    },
    "outbound": {
      "controller_ref": "src/controllers/MessageController.js:1-100",
      "repo_ref": "src/repositories/ConversationsRepository.js:545-770",
      "participants_build": {
        "adds_agent_email_sender": true,
        "adds_recipient_phone": true,
        "adds_default_viewers": true,
        "ref": "src/repositories/ConversationsRepository.js:676-682"
      },
      "workspace_tenant_source": "req.user",
      "idempotency_present": true,
      "fields": ["lastMessage","lastMessageAt","messageCount","participants","status","workspaceId","tenantId","updatedAt"]
    }
  },
  "env_and_config": {
    "env_read_refs": ["WORKSPACE_ID","TENANT_ID","DEFAULT_AGENT_EMAIL","DEFAULT_VIEWER_EMAILS","TENANT_MODE","LEGACY_COMPAT","LOG_CONV_DIAG","LOG_MSG_WRITE"],
    "where_read": [
      {"name":"DEFAULT_VIEWER_EMAILS","ref":"src/config/defaultViewers.js:10"},
      {"name":"DEFAULT_AGENT_EMAIL","ref":"src/config/defaultViewers.js:12"},
      {"name":"WORKSPACE_ID","ref":"src/config/twilioRouting.js:40"},
      {"name":"TENANT_ID","ref":"src/config/twilioRouting.js:41"},
      {"name":"LOG_CONV_DIAG","ref":"src/repositories/ConversationsRepository.js:210"},
      {"name":"LOG_MSG_WRITE","ref":"src/repositories/ConversationsRepository.js:458"}
    ],
    "twilio_routing_json_present": true,
    "twilio_routing_json_path": "config/twilioRouting.json:1-12"
  },
  "alignment_matrix": [
    {
      "field": "participants",
      "read_requires": "array-contains req.user.email",
      "inbound_writes": "phone + agentEmail? + default_viewers",
      "outbound_writes": "agentEmail(req.user) + phone + default_viewers",
      "gap": "NONE - default viewers est√°n siendo agregados en ambos flujos",
      "refs": ["src/repositories/ConversationsRepository.js:452-460", "src/repositories/ConversationsRepository.js:676-682"]
    },
    {
      "field": "workspaceId/tenantId",
      "read_requires": "== req.user.*",
      "inbound_source": "resolver/env",
      "outbound_source": "req.user",
      "gap": "NONE - ambos flujos establecen workspaceId/tenantId correctamente",
      "refs": ["src/services/MessageService.js:265-267", "src/repositories/ConversationsRepository.js:465-470"]
    }
  ],
  "known_runtime_issues": [
    {"id":"SOCKET_SET_UNDEFINED","present": true, "stack_ref":"src/socket/enterpriseSocketManager.js:628"}
  ],
  "verdicts": {
    "new_conversations_should_list_for_login_user": true,
    "historical_conversations_require_backfill": true,
    "blocking_gaps": []
  },
  "strict_next_steps": [
    {"id":"NS1","title":"If default viewers merge is missing, add module + merge on inbound/outbound","status":"present"},
    {"id":"NS2","title":"If historical lacks viewers, run backfill script","status":"present"},
    {"id":"NS3","title":"Ensure env DEFAULT_VIEWER_EMAILS matches front-login email","status":"unknown"}
  ]
} 