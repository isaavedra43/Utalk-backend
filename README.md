# üöÄ UTalk Backend - API Completa de Mensajer√≠a en Tiempo Real

> **Backend profesional para aplicaciones de mensajer√≠a tipo WhatsApp Web, Chatwoot, Intercom, Tidio**

[![Node.js](https://img.shields.io/badge/Node.js-v18+-green.svg)](https://nodejs.org/)
[![Firebase](https://img.shields.io/badge/Firebase-Latest-orange.svg)](https://firebase.google.com/)
[![Twilio](https://img.shields.io/badge/Twilio-WhatsApp-blue.svg)](https://www.twilio.com/)
[![Socket.IO](https://img.shields.io/badge/Socket.IO-v4.7+-red.svg)](https://socket.io/)
[![Production](https://img.shields.io/badge/Status-Production%20Ready-success.svg)](https://utalk-backend.railway.app/health)

## üìã Tabla de Contenidos

- [üåü Caracter√≠sticas Principales](#-caracter√≠sticas-principales)
- [üèóÔ∏è Arquitectura del Sistema](#-arquitectura-del-sistema)
- [üöÄ Instalaci√≥n y Configuraci√≥n](#-instalaci√≥n-y-configuraci√≥n)
- [üì° API REST Completa](#-api-rest-completa)
- [‚ö° Socket.IO - Tiempo Real](#-socketio---tiempo-real)
- [üí¨ Sistema de Conversaciones](#-sistema-de-conversaciones)
- [üìé Gesti√≥n de Multimedia](#-gesti√≥n-de-multimedia)
- [üë• Gesti√≥n de Usuarios y Roles](#-gesti√≥n-de-usuarios-y-roles)
- [üìä Analytics y M√©tricas](#-analytics-y-m√©tricas)
- [üîß Desarrollo y Testing](#-desarrollo-y-testing)
- [üöÄ Deployment](#-deployment)

## üåü Caracter√≠sticas Principales

### ‚úÖ **Sistema de Mensajer√≠a Completo**
- üì± **Integraci√≥n con WhatsApp Business** v√≠a Twilio
- üí¨ **Conversaciones en tiempo real** con Socket.IO
- üìé **Multimedia avanzado** (im√°genes, videos, audio, documentos)
- üîÑ **Sincronizaci√≥n bidireccional** con estado de mensajes
- üìã **Gesti√≥n de conversaciones** con estados y asignaci√≥n

### ‚úÖ **Tiempo Real Profesional**
- ‚ö° **Socket.IO con autenticaci√≥n** Firebase JWT
- üéØ **Salas por conversaci√≥n** para escalabilidad
- üëÄ **Indicadores de escritura** (typing indicators)
- üì® **Notificaciones instant√°neas** de nuevos mensajes
- üîÑ **Estados de conexi√≥n** y presencia de usuarios

### ‚úÖ **Gesti√≥n Avanzada de Multimedia**
- üóÇÔ∏è **Almacenamiento permanente** de archivos de Twilio
- üîç **Validaci√≥n de tipos** y firmas de archivos
- üìè **Optimizaci√≥n autom√°tica** por categor√≠as
- üîí **URLs seguras** con autenticaci√≥n
- üìä **Estad√≠sticas de almacenamiento**

### ‚úÖ **Sistema de Roles y Permisos**
- üëë **Admin**: Acceso completo al sistema
- üë®‚Äçüíº **Agent**: Gesti√≥n de conversaciones y mensajes
- üëÄ **Viewer**: Solo lectura en m√≥dulos espec√≠ficos
- üîê **Autenticaci√≥n Firebase** con JWT tokens

### ‚úÖ **Analytics y M√©tricas**
- üìä **Dashboard completo** con m√©tricas en tiempo real
- üìà **KPIs de rendimiento** por usuario y equipo
- üìã **Reportes exportables** en CSV/JSON
- ‚è±Ô∏è **Tiempos de respuesta** y productividad

## üèóÔ∏è Arquitectura del Sistema

```mermaid
graph TB
    subgraph "Frontend Clients"
        WEB[Web App]
        MOBILE[Mobile App]
        ADMIN[Admin Panel]
    end

    subgraph "Backend Services"
        API[Express.js API]
        SOCKET[Socket.IO Server]
        MEDIA[Media Service]
        TWILIO[Twilio Service]
    end

    subgraph "External Services"
        FB[Firebase Auth]
        FS[Firestore DB]
        TW[Twilio WhatsApp]
        STORAGE[File Storage]
    end

    WEB -->|REST + WebSocket| API
    MOBILE -->|REST + WebSocket| API
    ADMIN -->|REST + WebSocket| API

    API --> SOCKET
    API --> MEDIA
    API --> TWILIO

    API --> FB
    API --> FS
    TWILIO --> TW
    MEDIA --> STORAGE
```

## üöÄ Instalaci√≥n y Configuraci√≥n

### **Prerrequisitos**
- Node.js v18+
- Cuenta de Firebase con Firestore
- Cuenta de Twilio con WhatsApp Business
- Railway/Vercel/Heroku para deployment (opcional)

### **1. Clonar e Instalar**

```bash
git clone https://github.com/tu-usuario/utalk-backend.git
cd utalk-backend
npm install
```

### **2. Configuraci√≥n de Variables de Entorno**

Crea un archivo `.env` basado en `env.example`:

```env
# ===== CONFIGURACI√ìN GENERAL =====
NODE_ENV=development
PORT=3000
BACKEND_URL=http://localhost:3000
FRONTEND_URL=http://localhost:3001

# ===== FIREBASE CONFIGURATION =====
FIREBASE_PROJECT_ID=tu-proyecto-firebase
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nTU_CLAVE_PRIVADA\n-----END PRIVATE KEY-----"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@tu-proyecto.iam.gserviceaccount.com

# ===== TWILIO CONFIGURATION =====
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=tu_auth_token_twilio
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886

# ===== ALMACENAMIENTO DE MEDIA =====
MEDIA_DIR=./uploads/media
MEDIA_BASE_URL=http://localhost:3000/media

# ===== CONFIGURACI√ìN DE LOGS =====
LOG_LEVEL=info
```

### **3. Configuraci√≥n de Firebase**

1. **Crear proyecto en Firebase Console**
2. **Habilitar Firestore Database**
3. **Generar clave de servicio** (Admin SDK)
4. **Configurar reglas de Firestore** usando `firestore.rules`

### **4. Configuraci√≥n de Twilio**

1. **Configurar Sandbox de WhatsApp** o n√∫mero verificado
2. **Configurar webhook** apuntando a `/api/messages/webhook`
3. **Verificar configuraci√≥n** con el script:

```bash
npm run verify-webhook
```

### **5. Inicializar Base de Datos**

```bash
# Poblar con datos de ejemplo
npm run seed

# Verificar configuraci√≥n completa
npm run verify
```

## üì° API REST Completa

### **üîê Autenticaci√≥n**

Todas las rutas protegidas requieren header de autorizaci√≥n:

```http
Authorization: Bearer <firebase_jwt_token>
```

### **üí¨ Conversaciones**

```http
# Listar conversaciones con filtros
GET /api/conversations?status=open&assignedTo=user123&limit=20

# Obtener conversaci√≥n espec√≠fica
GET /api/conversations/conv_1234567890_0987654321

# Obtener mensajes de conversaci√≥n (paginado)
GET /api/conversations/conv_1234567890_0987654321/messages?limit=50&cursor=msg123

# Marcar conversaci√≥n como le√≠da
PUT /api/conversations/conv_1234567890_0987654321/read

# Asignar conversaci√≥n a agente
PUT /api/conversations/conv_1234567890_0987654321/assign
{
  "assignedTo": "agent-user-id"
}

# Cambiar estado de conversaci√≥n
PUT /api/conversations/conv_1234567890_0987654321/status
{
  "status": "closed"
}

# Archivar conversaci√≥n
DELETE /api/conversations/conv_1234567890_0987654321
```

### **üì® Mensajes**

```http
# Enviar mensaje
POST /api/messages/send
{
  "to": "+1234567890",
  "content": "Hola, ¬øc√≥mo est√°s?",
  "type": "text"
}

# Marcar mensaje como le√≠do
PUT /api/messages/msg123/read

# Marcar m√∫ltiples mensajes como le√≠dos
PUT /api/messages/read-multiple
{
  "messageIds": ["msg123", "msg124", "msg125"],
  "conversationId": "conv_1234567890_0987654321"
}

# Buscar mensajes
GET /api/messages/search?q=hola&limit=20

# Obtener estad√≠sticas
GET /api/messages/stats?startDate=2024-01-01&endDate=2024-01-31
```

### **üìé Multimedia**

```http
# Descargar archivo multimedia
GET /media/images/filename.jpg

# Obtener informaci√≥n de archivo
GET /media/info/images/filename.jpg

# Estad√≠sticas de almacenamiento (Admin)
GET /media/stats

# Limpiar archivos antiguos (Admin)
DELETE /media/cleanup?daysOld=30
```

### **üë• Contactos**

```http
# Listar contactos
GET /api/contacts?search=juan&tags=cliente,vip&limit=20

# Crear contacto
POST /api/contacts
{
  "name": "Juan P√©rez",
  "phone": "+1234567890",
  "email": "juan@example.com",
  "tags": ["cliente", "vip"]
}

# Actualizar contacto
PUT /api/contacts/contact123
{
  "name": "Juan Carlos P√©rez",
  "customFields": {
    "empresa": "Tech Corp",
    "cargo": "Manager"
  }
}
```

## ‚ö° Socket.IO - Tiempo Real

### **üîå Conexi√≥n al Servidor**

```javascript
import io from 'socket.io-client';

const socket = io('https://utalk-backend.railway.app', {
  auth: {
    token: firebaseJwtToken
  },
  transports: ['websocket', 'polling']
});

// Confirmar conexi√≥n
socket.on('connected', (data) => {
  console.log('Conectado:', data);
  // { userId, role, displayName, capabilities }
});
```

### **üì° Eventos del Cliente al Servidor**

```javascript
// Unirse a una conversaci√≥n espec√≠fica
socket.emit('join-conversation', 'conv_1234567890_0987654321', (response) => {
  if (response.success) {
    console.log('Unido a conversaci√≥n');
  }
});

// Salir de conversaci√≥n
socket.emit('leave-conversation', 'conv_1234567890_0987654321');

// Indicadores de escritura
socket.emit('typing-start', 'conv_1234567890_0987654321');
socket.emit('typing-stop', 'conv_1234567890_0987654321');

// Cambiar estado de usuario
socket.emit('status-change', 'away'); // online, away, busy, offline
```

### **üì® Eventos del Servidor al Cliente**

```javascript
// Nuevo mensaje en conversaci√≥n
socket.on('new-message', (data) => {
  console.log('Nuevo mensaje:', data);
  /*
  {
    type: 'new-message',
    conversationId: 'conv_1234567890_0987654321',
    message: {
      id: 'msg123',
      content: 'Hola!',
      from: '+1234567890',
      timestamp: '2024-01-15T10:30:00Z',
      type: 'text'
    }
  }
  */
});

// Mensaje marcado como le√≠do
socket.on('message-read', (data) => {
  console.log('Mensaje le√≠do:', data);
  /*
  {
    conversationId: 'conv_1234567890_0987654321',
    messageId: 'msg123',
    readBy: 'user-id'
  }
  */
});

// Estado de conversaci√≥n cambiado
socket.on('conversation-status-changed', (data) => {
  console.log('Estado cambiado:', data);
  /*
  {
    conversationId: 'conv_1234567890_0987654321',
    status: 'closed',
    changedBy: 'agent-id'
  }
  */
});

// Conversaci√≥n asignada
socket.on('conversation-assigned', (data) => {
  console.log('Conversaci√≥n asignada:', data);
});

// Usuario escribiendo
socket.on('user-typing', (data) => {
  console.log(`${data.displayName} est√° escribiendo...`);
});

// Usuario dej√≥ de escribir
socket.on('user-stopped-typing', (data) => {
  console.log(`${data.displayName} dej√≥ de escribir`);
});
```

### **üéØ Gesti√≥n de Salas**

```javascript
// El sistema autom√°ticamente gestiona las salas:
// - conversation-{conversationId}: Usuarios en conversaci√≥n espec√≠fica
// - role-admin: Todos los administradores
// - role-agent: Todos los agentes
// - role-viewer: Todos los viewers
```

## üí¨ Sistema de Conversaciones

### **üÜî Formato de conversationId**

```
conv_TELEFONO1_TELEFONO2
```

- **Ejemplo**: `conv_1234567890_0987654321`
- **Consistente**: Siempre genera el mismo ID para los mismos participantes
- **Ordenado**: Los n√∫meros se ordenan autom√°ticamente

### **üìä Estados de Conversaci√≥n**

| Estado | Descripci√≥n | Autom√°tico |
|--------|-------------|------------|
| `open` | Conversaci√≥n activa | ‚úÖ (al recibir mensaje) |
| `assigned` | Asignada a agente espec√≠fico | ‚ùå (manual) |
| `pending` | En espera de respuesta | ‚ùå (manual) |
| `closed` | Conversaci√≥n cerrada | ‚ùå (manual) |
| `archived` | Archivada | ‚ùå (manual) |

### **üéØ Prioridades**

- `low`: Baja prioridad
- `normal`: Prioridad normal (default)
- `high`: Alta prioridad
- `urgent`: Urgente

### **üìà M√©tricas Autom√°ticas**

```javascript
// Cada conversaci√≥n incluye autom√°ticamente:
{
  "messageCount": 25,          // Total de mensajes
  "unreadCount": 3,           // Mensajes no le√≠dos
  "lastMessageAt": "2024-01-15T10:30:00Z",
  "averageResponseTime": 120, // Segundos promedio
  "firstMessageAt": "2024-01-10T08:00:00Z"
}
```

## üìé Gesti√≥n de Multimedia

### **üóÇÔ∏è Categor√≠as Soportadas**

| Categor√≠a | Tipos | Tama√±o M√°x | Extensiones |
|-----------|-------|------------|-------------|
| `images` | Im√°genes | 10MB | jpg, png, gif, webp |
| `videos` | Videos | 50MB | mp4, webm, ogg |
| `audio` | Audio | 20MB | mp3, wav, ogg, webm |
| `documents` | Documentos | 25MB | pdf, txt, doc, docx |

### **üîÑ Procesamiento Autom√°tico**

1. **Recepci√≥n**: Webhook de Twilio contiene URL temporal
2. **Descarga**: MediaService descarga el archivo autom√°ticamente
3. **Validaci√≥n**: Verificaci√≥n de tipo MIME y firma de archivo
4. **Almacenamiento**: Guardado categorizado con nombre √∫nico
5. **URL Permanente**: Generaci√≥n de URL p√∫blica segura

### **üîí Seguridad de Archivos**

```javascript
// Validaciones implementadas:
- Verificaci√≥n de tipo MIME
- Validaci√≥n de firma de archivo (magic numbers)
- L√≠mites de tama√±o por categor√≠a
- Autenticaci√≥n requerida para descargar
- Nombres de archivo seguros (sin path traversal)
```

### **üìä Estad√≠sticas de Almacenamiento**

```http
GET /media/stats
```

```json
{
  "stats": {
    "totalFiles": 1250,
    "totalSize": 524288000,
    "totalSizeFormatted": "500.0 MB",
    "byCategory": {
      "images": {
        "files": 800,
        "size": 314572800,
        "sizeFormatted": "300.0 MB"
      },
      "videos": {
        "files": 50,
        "size": 157286400,
        "sizeFormatted": "150.0 MB"
      }
    }
  }
}
```

## üë• Gesti√≥n de Usuarios y Roles

### **üîë Roles del Sistema**

#### **üëë Admin (Administrador)**
- ‚úÖ Acceso completo a todas las funcionalidades
- ‚úÖ Gesti√≥n de usuarios y roles
- ‚úÖ Configuraci√≥n del sistema
- ‚úÖ M√©tricas y analytics completos
- ‚úÖ Gesti√≥n de multimedia y almacenamiento

#### **üë®‚Äçüíº Agent (Agente)**
- ‚úÖ Gesti√≥n de conversaciones asignadas
- ‚úÖ Env√≠o y recepci√≥n de mensajes
- ‚úÖ Gesti√≥n de contactos
- ‚úÖ Creaci√≥n de campa√±as
- ‚úÖ Acceso a base de conocimiento
- ‚ùå Gesti√≥n de usuarios
- ‚ùå Configuraci√≥n del sistema

#### **üëÄ Viewer (Visualizador)**
- ‚úÖ Solo lectura en conversaciones
- ‚úÖ Visualizaci√≥n de m√©tricas b√°sicas
- ‚úÖ Acceso a base de conocimiento p√∫blica
- ‚ùå Env√≠o de mensajes
- ‚ùå Gesti√≥n de contactos
- ‚ùå Creaci√≥n de campa√±as

### **üîê Autenticaci√≥n y Autorizaci√≥n**

```javascript
// Middleware de autenticaci√≥n
const authMiddleware = async (req, res, next) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  const decodedToken = await firebase.auth().verifyIdToken(token);
  req.user = await User.getById(decodedToken.uid);
  next();
};

// Middleware de roles
const requireAdmin = (req, res, next) => {
  if (req.user.role !== 'admin') {
    return res.status(403).json({ error: 'Acceso denegado' });
  }
  next();
};
```

## üìä Analytics y M√©tricas

### **üìà Dashboard Principal**

```http
GET /api/dashboard/metrics?period=7d
```

```json
{
  "summary": {
    "totalMessages": 1520,
    "totalContacts": 450,
    "activeConversations": 25,
    "averageResponseTime": 180
  },
  "trends": {
    "messagesGrowth": 15.5,
    "contactsGrowth": 8.2,
    "responseTimeImprovement": -12.3
  },
  "topPerformers": [
    {
      "agent": "Juan P√©rez",
      "messagesHandled": 320,
      "avgResponseTime": 120
    }
  ]
}
```

### **üë• M√©tricas de Equipo**

```http
GET /api/dashboard/performance?period=30d
```

### **üí¨ Estad√≠sticas de Conversaciones**

```http
GET /api/conversations/stats
```

### **üìä Reportes Exportables**

```http
# Exportar reporte de campa√±a en CSV
GET /api/campaigns/{id}/report?format=csv

# Exportar m√©tricas de equipo
GET /api/dashboard/export?period=30d&format=csv
```

## üîß Desarrollo y Testing

### **üöÄ Scripts Disponibles**

```bash
# Desarrollo
npm run dev          # Iniciar con nodemon
npm start           # Iniciar en producci√≥n

# Base de datos
npm run seed        # Poblar DB con datos de ejemplo
npm run verify      # Verificar configuraci√≥n completa

# Testing
npm test           # Ejecutar tests
npm run test:watch # Tests en modo watch

# Utilidades
npm run verify-webhook    # Verificar configuraci√≥n de Twilio
npm run cleanup-media    # Limpiar archivos multimedia antiguos
```

### **üß™ Testing**

```bash
# Ejecutar tests espec√≠ficos
npm test -- --testNamePattern="Conversation"
npm test -- tests/messages.test.js

# Coverage
npm run test:coverage
```

### **üìù Logging**

```javascript
// El sistema incluye logging estructurado:
logger.info('Mensaje procesado', {
  messageId: 'msg123',
  conversationId: 'conv_123_456',
  userId: 'user123',
  processing_time: 150
});

// Niveles disponibles: error, warn, info, debug
```

### **üîç Debugging**

```bash
# Habilitar logs detallados
DEBUG=utalk:* npm run dev

# Solo logs de Socket.IO
DEBUG=socket.io:* npm run dev

# Logs de Firestore
DEBUG=firestore:* npm run dev
```

## üöÄ Deployment

### **‚òÅÔ∏è Railway (Recomendado)**

1. **Conectar repositorio** a Railway
2. **Configurar variables de entorno** en Railway Dashboard
3. **Deploy autom√°tico** con cada push a main

```bash
# Verificar deployment
curl https://tu-app.railway.app/health
```

### **üåê Vercel**

```bash
# Instalar CLI
npm i -g vercel

# Deploy
vercel --prod

# Configurar variables de entorno
vercel env add FIREBASE_PROJECT_ID
```

### **üê≥ Docker**

```dockerfile
# Dockerfile incluido en el proyecto
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

```bash
# Build y run
docker build -t utalk-backend .
docker run -p 3000:3000 --env-file .env utalk-backend
```

### **üîß Variables de Entorno para Producci√≥n**

```env
NODE_ENV=production
PORT=3000
BACKEND_URL=https://tu-dominio.com
FRONTEND_URL=https://tu-frontend.com

# Firebase (usar variables de Railway/Vercel)
FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID
FIREBASE_PRIVATE_KEY=$FIREBASE_PRIVATE_KEY
FIREBASE_CLIENT_EMAIL=$FIREBASE_CLIENT_EMAIL

# Twilio
TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID
TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN
TWILIO_WHATSAPP_NUMBER=$TWILIO_WHATSAPP_NUMBER

# Media (usar bucket externo en producci√≥n)
MEDIA_BASE_URL=https://tu-dominio.com/media
```

## üìö Documentaci√≥n Adicional

- üìñ **[API Documentation](./docs/swagger.yaml)** - Swagger/OpenAPI completo
- üèóÔ∏è **[Architecture Guide](./docs/architecture.md)** - Gu√≠a de arquitectura
- üîß **[Development Guide](./docs/development.md)** - Gu√≠a de desarrollo
- üöÄ **[Deployment Guide](./DEPLOY_GUIDE.md)** - Gu√≠a de deployment
- üß™ **[Testing Guide](./docs/testing.md)** - Gu√≠a de testing

## ü§ù Contribuci√≥n

1. **Fork** el repositorio
2. **Crear** branch para feature (`git checkout -b feature/nueva-funcionalidad`)
3. **Commit** cambios (`git commit -am 'Agregar nueva funcionalidad'`)
4. **Push** al branch (`git push origin feature/nueva-funcionalidad`)
5. **Crear** Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT. Ver el archivo [LICENSE](LICENSE) para detalles.

## üÜò Soporte

- üìß **Email**: support@funday.com
- üí¨ **Discord**: [Unirse al servidor](https://discord.gg/funday)
- üì± **WhatsApp**: +1 (555) 123-4567
- üêõ **Issues**: [GitHub Issues](https://github.com/tu-usuario/utalk-backend/issues)

---

### üéâ ¬°Backend Listo para Producci√≥n!

Este backend est√° completamente preparado para soportar aplicaciones de mensajer√≠a profesionales con:

- ‚úÖ **Tiempo real** con Socket.IO
- ‚úÖ **Multimedia avanzado** 
- ‚úÖ **Conversaciones estructuradas**
- ‚úÖ **Roles y permisos**
- ‚úÖ **Analytics completos**
- ‚úÖ **Documentaci√≥n completa**
- ‚úÖ **Listo para escalar**

**¬°Perfecto para construir tu propio WhatsApp Web, Chatwoot, Intercom o Tidio!** üöÄ 