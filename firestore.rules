rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // === REGLAS TEMPORALES PARA DEBUGGING ===
    // Permitir escritura temporal para identificar el problema
    match /conversations/{conversationId} {
      allow read, write: if true;
      
      match /messages/{messageId} {
        allow read, write: if true;
      }
    }
    
    // Reglas originales comentadas temporalmente
    /*
    // Función para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Función para verificar si el usuario es el propietario
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Función para verificar si el usuario es admin
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // Función para verificar si el usuario es agente o superior
    function isAgentOrAbove() {
      return isAuthenticated() && (
        request.auth.token.role == 'admin' ||
        request.auth.token.role == 'agent' ||
        request.auth.token.role == 'supervisor'
      );
    }

    // Función para verificar si es una petición de webhook
    function isWebhookRequest() {
      return request.auth == null && 
             request.headers['user-agent'] != null &&
             (request.headers['user-agent'].contains('Twilio') ||
              request.headers['user-agent'].contains('webhook'));
    }

    // Reglas para conversaciones
    match /conversations/{conversationId} {
      // Permitir lectura si el usuario está autenticado
      allow read: if isAuthenticated();
      
      // Permitir escritura si es webhook o usuario autenticado
      allow write: if isWebhookRequest() || isAuthenticated();
      
      // Reglas para subcolección de mensajes
      match /messages/{messageId} {
        // Permitir lectura si el usuario está autenticado
        allow read: if isAuthenticated();
        
        // Permitir escritura si es webhook o usuario autenticado
        allow write: if isWebhookRequest() || isAuthenticated();
      }
    }

    // Reglas para usuarios
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // Reglas para contactos
    match /contacts/{contactId} {
      allow read, write: if isAuthenticated();
    }

    // Reglas para campañas
    match /campaigns/{campaignId} {
      allow read, write: if isAgentOrAbove();
    }

    // Reglas para archivos
    match /files/{fileId} {
      allow read, write: if isAuthenticated();
    }
    */
  }
} 